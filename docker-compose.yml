version: "3.9"

services:
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - NEXT_PUBLIC_PROXY_HTTP_URL=${NEXT_PUBLIC_PROXY_HTTP_URL}
      - NEXT_PUBLIC_PROXY_DNS_ADDR=${NEXT_PUBLIC_PROXY_DNS_ADDR}
      - NEXT_PUBLIC_PROXY_HEALTH_URL=${NEXT_PUBLIC_PROXY_HEALTH_URL}
      - PAYMENTS_API_BASE_URL=${PAYMENTS_API_BASE_URL}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
      - ANALYTICS_API_BASE_URL=${ANALYTICS_API_BASE_URL}
    depends_on:
      - payments
      - proxy
    ports:
      - "3000:3000"
    restart: unless-stopped
    networks:
      - payhole-net

  payments:
    build:
      context: ./payments
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - HELIUS_RPC_URL=${HELIUS_RPC_URL}
      - JWT_SECRET=${JWT_SECRET}
      - PORT=4000
      - UNLOCK_DB_PATH=${UNLOCK_DB_PATH:-data/unlocks.json}
      - USDC_MINT_ADDRESS=${USDC_MINT_ADDRESS}
    volumes:
      - ./payments/data:/app/data
    ports:
      - "4000:4000"
    restart: unless-stopped
    networks:
      - payhole-net

  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - HTTP_PROXY_ADDR=:8080
      - DNS_PROXY_ADDR=:5353
      - UPSTREAM_DNS_ADDR=${UPSTREAM_DNS_ADDR:-1.1.1.1:53}
      - BLOCKLIST_PATH=${BLOCKLIST_PATH:-data/blocklist.txt}
      - PAYMENTS_JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./proxy/data:/home/payhole/data
    ports:
      - "8080:8080"
      - "5353:5353"
      - "5353:5353/udp"
    restart: unless-stopped
    networks:
      - payhole-net

networks:
  payhole-net:
    driver: bridge

