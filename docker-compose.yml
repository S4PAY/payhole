services:
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_PROXY_HTTP_URL: ${NEXT_PUBLIC_PROXY_HTTP_URL}
        NEXT_PUBLIC_PROXY_DNS_ADDR: ${NEXT_PUBLIC_PROXY_DNS_ADDR}
        NEXT_PUBLIC_PROXY_HEALTH_URL: ${NEXT_PUBLIC_PROXY_HEALTH_URL}
        PAYMENTS_API_BASE_URL: ${PAYMENTS_API_BASE_URL}
        ANALYTICS_API_BASE_URL: ${ANALYTICS_API_BASE_URL}
        NEXT_PUBLIC_TREASURY_WALLET: ${NEXT_PUBLIC_TREASURY_WALLET}
        NEXT_PUBLIC_PAYMENT_AMOUNT_USDC: ${NEXT_PUBLIC_PAYMENT_AMOUNT_USDC}
        NEXT_PUBLIC_USDC_MINT_ADDRESS: ${NEXT_PUBLIC_USDC_MINT_ADDRESS}
        NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-PayHole}
    env_file:
      - .env
    environment:
      NEXT_PUBLIC_PROXY_HTTP_URL: ${NEXT_PUBLIC_PROXY_HTTP_URL}
      NEXT_PUBLIC_PROXY_DNS_ADDR: ${NEXT_PUBLIC_PROXY_DNS_ADDR}
      NEXT_PUBLIC_PROXY_HEALTH_URL: ${NEXT_PUBLIC_PROXY_HEALTH_URL}
      PAYMENTS_API_BASE_URL: ${PAYMENTS_API_BASE_URL}
      NEXT_PUBLIC_TREASURY_WALLET: ${NEXT_PUBLIC_TREASURY_WALLET:-}
      NEXT_PUBLIC_PAYMENT_AMOUNT_USDC: ${NEXT_PUBLIC_PAYMENT_AMOUNT_USDC:-5}
      NEXT_PUBLIC_USDC_MINT_ADDRESS: ${NEXT_PUBLIC_USDC_MINT_ADDRESS:-EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZeh9Bx}
      ANALYTICS_API_BASE_URL: ${ANALYTICS_API_BASE_URL}
      ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET}
    depends_on:
      - payments
      - proxy
    ports:
      - "3000:3000"
    restart: unless-stopped
    networks:
      - payhole-net

  payments:
    build:
      context: ./payments
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      HELIUS_RPC_URL: ${HELIUS_RPC_URL}
      JWT_SECRET: ${JWT_SECRET}
      PORT: 4000
      UNLOCK_DB_PATH: ${UNLOCK_DB_PATH}
      USDC_MINT_ADDRESS: ${USDC_MINT_ADDRESS}
      TREASURY_WALLET: ${TREASURY_WALLET}
      MIN_PAYMENT_USDC: ${MIN_PAYMENT_USDC:-5}
      PROXY_UNLOCK_WEBHOOK: ${PROXY_UNLOCK_WEBHOOK}
    volumes:
      - ./payments/data:/app/data
    ports:
      - "3001:4000"
    restart: unless-stopped
    networks:
      - payhole-net

  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    env_file:
      - .env
    depends_on:
      - payments
    environment:
      HTTP_PROXY_ADDR: :8080
      DNS_PROXY_ADDR: :5353
      UPSTREAM_DNS_ADDR: ${UPSTREAM_DNS_ADDR}
      BLOCKLIST_PATH: ${BLOCKLIST_PATH}
      PAYMENTS_JWT_SECRET: ${JWT_SECRET}
      PROXY_UNLOCK_WEBHOOK: ${PROXY_UNLOCK_WEBHOOK}
    volumes:
      - ./proxy/data:/home/payhole/data
    ports:
      - "8080:8080"
      - "5533:5353"
      - "5533:5353/udp"
    restart: unless-stopped
    networks:
      - payhole-net

networks:
  payhole-net:
    driver: bridge
